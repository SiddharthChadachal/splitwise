name: Publish Packages (APT & RPM)

on:
  workflow_run:
    workflows: ["Release"]      # MUST match GoReleaser workflow name
    types:
      - completed

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Wait for Release to be available (avoid 404 race condition)
      - name: Wait for GitHub Release to exist
        run: |
          TAG="${{ github.event.workflow_run.head_branch }}"
          echo "Waiting for release of tag: $TAG"
          for i in {1..12}; do
            sleep 5
            STATUS=$(curl -s \
              "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG" \
              | jq -r '.id')
            if [ "$STATUS" != "null" ]; then
              echo "Release detected: $STATUS"
              break
            fi
            echo "Still waiting..."
          done

      - name: Download all assets from Release
        uses: robinraju/release-downloader@v1
        with:
          repository: ${{ github.repository }}
          tag: ${{ github.event.workflow_run.head_branch }}
          filePattern: "*.deb,*.rpm"

      - name: Install metadata tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev createrepo-c

      - name: Prepare repo structure
        run: |
          mkdir -p repo/apt/pool
          mkdir -p repo/rpm
          cp *.deb repo/apt/pool/ || true
          cp *.rpm repo/rpm/ || true

      - name: Build APT metadata
        run: |
          cd repo/apt
          mkdir -p dists/stable/main/binary-amd64
          dpkg-scanpackages pool > dists/stable/main/binary-amd64/Packages
          gzip -kf dists/stable/main/binary-amd64/Packages
          cat > Release <<EOF
          Origin: ${GITHUB_REPOSITORY}
          Label: splitwise
          Suite: stable
          Codename: stable
          Architecture: amd64
          EOF

      - name: Build RPM metadata
        run: |
          createrepo-c repo/rpm

      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: repo
          publish_branch: gh-pages
