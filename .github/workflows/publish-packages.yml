name: Publish Packages (RPM and APT) to GitHub Pages
#testing new fix
on:
  release:
      types: [published]


jobs:
    publish:
        runs-on: Ubuntu-Latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                fetch-depth: 0

            - name: Downloading .deb from Releases
              uses: robinraju/release-downloader@v1
              with:
                repository: ${{ github.repository }}
                #tag:
                fileName: '*.deb'
                preRelease: false
                latest: true

            - name: Downloading .rpm from Releases
              uses: robinraju/release-downloader@v1
              with:
                repository: ${{ github.repository }}
                #tag:
                fileName: '*.rpm'
                preRelease: false
                latest: true


            - name: Install tools
              run: |
                sudo apt-get update
                sudo apt-get install -y dpkg-dev gnupg createrepo_c
            
            - name: prepare repo structure
              run: | 
                mkdir -p repo/apt/pool
                mkdir -p repo/rpm
                mv *.deb repo/apt/pool
                mv *.rpm repo/rpm

            - name: Build APT metadata
              run: |
                cd repo/apt
                mkdir -p dists/stable/main/binary-amd64
                mkdir -p dists/stable/main/binary-arm64
                # create Packages list in the pool directory (dpkg-scanpackages expects a directory to scan)
                dpkg-scanpackages pool /dev/null > dists/stable/main/binary-amd64/Packages || true
                gzip -kf dists/stable/main/binary-amd64/Packages || true
                # Create a Release file
                cat > Release <<'EOF'
                Origin: ${{ github.repository }}
                Label: splitwise
                Suite: stable
                Codename: stable
                Architecture: amd64
                EOF

            - name: Build RPM metadata
              run: |
                createrepo_c repo/rpm

            - name: Publish to Github Pages
              uses: peaceiris/actions-gh-pages@v3
              with:
                github_token: ${{ secrets.GITHUB_TOKEN }}
                publish_dir: repo
                publish_branch: gh-pages
